#include "Lcd.h"

#define LCD_RS  0
#define LCD_RW  1
#define LCD_EN  2
#define LCD_BL  3
#define LCD_4BIT_FUNCTION_SET 0x28
#define LCD_DISP_OFF          0x08
#define LCD_DISP_ON           0x0C
#define LCD_DISP_CLEAR        0x01
#define LCD_DISP_ENTRY_MODE   0x06

#define LCD_DEV_ADDR          0x27

static I2C_HandleTypeDef *hLCDI2C;

static uint8_t LCDData = 0;

static void LCD_cmdMode();
static void LCD_charMode();
static void LCD_writeMode();
static void LCD_readMode();
static void LCD_EN_High();
static void LCD_EN_Low();
static void LCD_SendNibbleData(uint8_t data);
static void LCD_SendData(uint8_t data);
static void LCD_writeCmdData(uint8_t data);




void LCD_Init(I2C_HandleTypeDef *hI2C)
{
	hLCDI2C = hI2C;
	HAL_Delay(50); //delay 50ms
	LCD_cmdMode();
	LCD_writeMode();
	LCD_SendNibbleData(0x30); //상위 4bit 한번 보냄

	HAL_Delay(5); //delay 50ms
	LCD_SendNibbleData(0x30);

	HAL_Delay(1); //delay 50m
	LCD_SendNibbleData(0x30);
	LCD_SendNibbleData(0x20);
	LCD_SendData(LCD_4BIT_FUNCTION_SET); //Fuction Set 설정
	LCD_SendData(LCD_DISP_OFF);
	LCD_SendData(LCD_DISP_CLEAR);
	LCD_SendData(LCD_DISP_ENTRY_MODE);
	LCD_SendData(LCD_DISP_ON);
	LCD_backLightOn(LCD_DISP_ON);

}

void LCD_backLightOn()
{
	LCDData |= (1<<LCD_BL);
}

void LCD_backLightOff()
{
	LCDData &= ~(1<<LCD_BL);
}

//RS Mode Select
void LCD_cmdMode()  // RS가 0일 때 cmd mode
{
	LCDData &= ~(1<<LCD_RS);
	LCD_sendI2C(LCDData);
}

void LCD_charMode()  // RS가 1일 때 data mode
{
	LCDData |= (1<<LCD_RS);
	LCD_sendI2C(LCDData);
}



//RW Mode Select
void LCD_writeMode()
{
	LCDData &= ~(1<<LCD_RW);
	LCD_sendI2C(LCDData);
}

void LCD_readMode()
{
	LCDData |= (1<<LCD_RW);
	LCD_sendI2C(LCDData);
}



//Enable
void LCD_EN_High()
{
	LCDData |= (1<<LCD_EN);
	LCD_sendI2C(LCDData);
}

void LCD_EN_Low()
{
	LCDData &= ~(1<<LCD_EN);
	LCD_sendI2C(LCDData);
}


//LCD Datacut
void LCD_SendNibbleData(uint8_t data) //Nibble : 4bit만 전송
{
	LCD_EN_High();
	//상위 4bit
	LCDData = (data & 0xf0) | (LCDData & 0x0f); //data의 상위 bit를 얻기 위함
	LCD_sendI2C(LCDData);
	LCD_EN_Low();    // E High->LOW 데이터 전송
}


void LCD_SendData(uint8_t data)
{
	//상위 4bit
	LCD_SendNibbleData(data);
	//하위 4bit
	data = data << 4;
	LCD_SendNibbleData(data);
}


//LCD Write
void LCD_writeCmdData(uint8_t data)
{
	 LCD_writeMode();
	 LCD_cmdMode();
	 LCD_SendData(data);
}

void LCD_writeCharData(uint8_t data)
{
	 LCD_writeMode();
	 LCD_charMode();
	 LCD_SendData(data);
}


void LCD_sendI2C(uint8_t data)
{
	HAL_I2C_Master_Transmit(hLCDI2C, LCD_DEV_ADDR << 1, &data, 1, 1000);
}

#include "Listener.h"
#include "usart.h"

static void Listener_CheckButton(void); //외부에서 못부름
static void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart);

uint8_t uart_rx_data;

void Listener_Init()
{
	Button_Init(&hBtnMode, GPIOB,  GPIO_PIN_5);
	Button_Init(&hBtnRunStop, GPIOB, GPIO_PIN_3);
	Button_Init(&hBtnClear, GPIOA, GPIO_PIN_10);

	// 인터럽트 방식 UART 수신 시작
	HAL_UART_Receive_IT(&huart2, &uart_rx_data, 1);
}

void Listener_Execute()
{
	HAL_UART_RxCpltCallback();
	Listener_CheckButton();
}

void Listener_CheckButton(void)
{
	inputData_TypeDef inputData;

	if(Button_GetState(&hBtnMode) == ACT_RELEASED){
		inputData.id = MODE;
		inputData.data = MODE_ACT;
		Controller_SetInputData(inputData);
	}
	else if (Button_GetState(&hBtnRunStop) == ACT_PUSHED){
		inputData.id = STOPWATCH_RUNSTOP;
		inputData.data = STOPWATCH_ACT;
		Controller_SetInputData(inputData);
	}
	else if (Button_GetState(&hBtnClear) == ACT_PUSHED){
		inputData.id = STOPWATCH_CLEAR;
		inputData.data = STOPWATCH_ACT;
		Controller_SetInputData(inputData);
	}
}

void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)
{
	if (huart->Instance == USART2) // huart2를 사용할 때
	{
		inputData_TypeDef inputData;

		switch (uart_rx_data)
		{
		case 'm':
			inputData.id = MODE;
			inputData.data = MODE_ACT;
			break;
		case 's':
			inputData.id = STOPWATCH_RUNSTOP;
			inputData.data = STOPWATCH_ACT;
			break;
		case 'c':
			inputData.id = STOPWATCH_CLEAR;
			inputData.data = STOPWATCH_ACT;
			break;
		default:
			return; // 아무 처리도 안 함
		}

		Controller_SetInputData(inputData);

		// 다음 수신 요청 재시작
		HAL_UART_Receive_IT(&huart2, &uart_rx_data, 1);
	}
}

